"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.processNode = void 0;

var _dumper = require("dumper.js");

require("source-map-support/register");

var _gatsbyPluginSharp = require("gatsby-plugin-sharp");

var _gatsbyImage = _interopRequireDefault(require("gatsby-image"));

var _react = _interopRequireDefault(require("react"));

var _server = _interopRequireDefault(require("react-dom/server"));

var _fastJsonStableStringify = _interopRequireDefault(require("fast-json-stable-stringify"));

var _execall = _interopRequireDefault(require("execall"));

var _cheerio = _interopRequireDefault(require("cheerio"));

var _index = _interopRequireDefault(require("./create-remote-file-node/index"));

var _fetchReferencedMediaItems = _interopRequireWildcard(require("../fetch-nodes/fetch-referenced-media-items"));

var _store = _interopRequireDefault(require("../../../store"));

var _btoa = _interopRequireDefault(require("btoa"));

// @todo this doesn't make sense because these aren't all images
const imgSrcRemoteFileRegex = /(?:src=\\")((?:(?:https?|ftp|file):\/\/|www\.|ftp\.)(?:\([-A-Z0-9+&@#/%=~_|$?!:,.]*\)|[-A-Z0-9+&@#/%=~_|$?!:,.])*(?:\([-A-Z0-9+&@#/%=~_|$?!:,.]*\)|[A-Z0-9+&@#/%=~_|$])\.(?:xjpeg|jpg|png|gif|ico|pdf|doc|docx|ppt|pptx|pps|ppsx|odt|xls|psd|mp3|m4a|ogg|wav|mp4|m4v|mov|wmv|avi|mpg|ogv|3gp|3g2|svg|bmp|tif|tiff|asf|asx|wm|wmx|divx|flv|qt|mpe|webm|mkv|tt|asc|c|cc|h|csv|tsv|ics|rtx|css|htm|html|m4b|ra|ram|mid|midi|wax|mka|rtf|js|swf|class|tar|zip|gz|gzip|rar|7z|exe|pot|wri|xla|xlt|xlw|mdb|mpp|docm|dotx|dotm|xlsm|xlsb|xltx|xltm|xlam|pptm|ppsm|potx|potm|ppam|sldx|sldm|onetoc|onetoc2|onetmp|onepkg|odp|ods|odg|odc|odb|odf|wp|wpd|key|numbers|pages))(?=\\"| |\.)/gim;
const imgTagRegex = /<img([\w\W]+?)[\/]?>/gim;

const findReferencedImageNodeIds = ({
  nodeString,
  pluginOptions,
  referencedMediaItemNodeIds,
  node
}) => {
  // if the lazyNodes plugin option is set we don't need to find
  // image node id's because those nodes will be fetched lazily in resolvers
  if (pluginOptions.type.MediaItem.lazyNodes) {
    return;
  } // get an array of all referenced media file ID's


  const matchedIds = (0, _execall.default)(/"id":"([^"]*)","sourceUrl"/gm, nodeString).map(match => match.subMatches[0]).filter(id => id !== node.id);
  return matchedIds;
};

const getCheerioImgDbId = cheerioImg => {
  // try to get the db id from data attributes
  const dataAttributeId = cheerioImg.attribs[`data-id`] || cheerioImg.attribs[`data-image-id`];

  if (dataAttributeId) {
    return dataAttributeId;
  }

  if (!cheerioImg.attribs.class) {
    return null;
  } // try to get the db id from the wp-image-id classname
  // const wpImageClass = cheerioImg.attribs.class
  //   .split(` `)
  //   .find((className) => className.includes(`wp-image-`))
  // if (wpImageClass) {
  //   const wpImageClassDashArray = wpImageClass.split(`-`)
  //   const wpImageClassId = Number(
  //     wpImageClassDashArray[wpImageClassDashArray.length - 1]
  //   )
  //   if (wpImageClassId) {
  //     return wpImageClassId
  //   }
  // }


  return null;
};

const dbIdToMediaItemRelayId = dbId => dbId ? (0, _btoa.default)(`post:${dbId}`) : null;

const getCheerioImgRelayId = cheerioImg => dbIdToMediaItemRelayId(getCheerioImgDbId(cheerioImg));

const fetchNodeHtmlImageMediaItemNodes = async ({
  cheerioImages,
  nodeString,
  node,
  helpers
}) => {
  // check if we have any of these nodes locally already
  // build a query to fetch all media items that we don't already have
  const mediaItemUrls = cheerioImages.map(({
    cheerioImg
  }) => cheerioImg.attribs.src);
  const mediaItemNodesBySourceUrl = await (0, _fetchReferencedMediaItems.default)({
    mediaItemUrls
  }); // images that have been edited from the media library that were previously
  // uploaded to a post/page will have a different sourceUrl so they can't be fetched by it
  // in many cases we have data-id or data-image-id as attributes on the img
  // we can try to use those to fetch media item nodes as well
  // this will keep us from missing nodes

  const mediaItemDbIds = cheerioImages.map(({
    cheerioImg
  }) => getCheerioImgDbId(cheerioImg)).filter(Boolean); // media items are of the post type

  const mediaItemRelayIds = mediaItemDbIds.map(dbId => dbIdToMediaItemRelayId(dbId)).filter( // filter out any media item ids we already fetched
  relayId => !mediaItemNodesBySourceUrl.find(({
    id
  }) => id === relayId));
  const mediaItemNodesById = await (0, _fetchReferencedMediaItems.default)({
    referencedMediaItemNodeIds: mediaItemRelayIds
  });
  const mediaItemNodes = [...mediaItemNodesById, ...mediaItemNodesBySourceUrl];
  const htmlMatchesToMediaItemNodesMap = new Map();

  for (const {
    cheerioImg,
    match
  } of cheerioImages) {
    const htmlImgSrc = cheerioImg.attribs.src;
    const possibleHtmlSrcs = [// try to match the media item source url by original html src
    htmlImgSrc, // or by the src minus any image sizes string
    (0, _fetchReferencedMediaItems.stripImageSizesFromUrl)(htmlImgSrc)];
    let imageNode = mediaItemNodes.find(mediaItemNode => // either find our node by the source url
    possibleHtmlSrcs.includes(mediaItemNode.sourceUrl) || // or by id for cases where the src url didn't return a node
    getCheerioImgRelayId(cheerioImg) === mediaItemNode.id);

    if (!imageNode && htmlImgSrc) {
      // if we didn't get a media item node for this image,
      // we need to fetch it and create a file node for it with no
      // media item node.
      imageNode = await (0, _index.default)(Object.assign(Object.assign({
        url: htmlImgSrc,
        // fixedBarTotal,
        parentNodeId: node.id
      }, helpers), {}, {
        createNode: helpers.actions.createNode
      }));
    }

    if (imageNode) {
      // match is the html string of the img tag
      htmlMatchesToMediaItemNodesMap.set(match, {
        imageNode,
        cheerioImg
      });
    }
  }

  return htmlMatchesToMediaItemNodesMap;
};

const getCheerioImgFromMatch = ({
  match
}) => {
  // unescape quotes
  const parsedMatch = JSON.parse(`"${match}"`); // load our matching img tag into cheerio

  const $ = _cheerio.default.load(parsedMatch, {
    xml: {
      // make sure it's not wrapped in <body></body>
      withDomLvl1: false,
      // no need to normalize whitespace, we're dealing with a single element here
      normalizeWhitespace: false,
      xmlMode: true,
      // entity decoding isn't our job here, that will be the responsibility of WPGQL
      // or of the source plugin elsewhere.
      decodeEntities: false
    }
  }); // there's only ever one image due to our match matching a single img tag
  // $(`img`) isn't an array, it's an object with a key of 0


  const cheerioImg = $(`img`)[0];
  return {
    match,
    cheerioImg
  };
};

const getLargestSizeFromSizesAttribute = sizesString => {
  const sizesStringsArray = sizesString.split(`,`);
  return sizesStringsArray.reduce((largest, currentSizeString) => {
    const maxWidth = currentSizeString.substring(currentSizeString.indexOf(`max-width: `) + 1, currentSizeString.indexOf(`px`)).trim();
    const maxWidthNumber = Number(maxWidth);
    const noLargestAndMaxWidthIsANumber = !largest && !isNaN(maxWidthNumber);
    const maxWidthIsALargerNumberThanLargest = largest && !isNaN(maxWidthNumber) && maxWidthNumber > largest;

    if (noLargestAndMaxWidthIsANumber || maxWidthIsALargerNumberThanLargest) {
      largest = maxWidthNumber;
    }

    return largest;
  }, null);
};

const findImgTagMaxWidthFromCheerioImg = cheerioImg => {
  const {
    attribs: {
      width,
      sizes
    }
  } = cheerioImg || {
    attribs: {
      width: null,
      sizes: null
    }
  };

  if (width) {
    const widthNumber = Number(width);

    if (!isNaN(widthNumber)) {
      return width;
    }
  }

  if (sizes) {
    const largestSize = getLargestSizeFromSizesAttribute(sizes);

    if (largestSize && !isNaN(largestSize)) {
      return largestSize;
    }
  }

  return null;
};

const replaceNodeHtmlImages = async ({
  nodeString,
  node,
  helpers,
  wpUrl // pluginOptions,

}) => {
  const imageUrlMatches = (0, _execall.default)(imgSrcRemoteFileRegex, nodeString);
  const imgTagMatches = (0, _execall.default)(imgTagRegex, nodeString).filter(({
    match
  }) => // @todo make it a plugin option to fetch non-wp images
  // here we're filtering out image tags that don't contain our site url
  match.includes(wpUrl));

  if (imageUrlMatches.length) {
    const cheerioImages = imgTagMatches.map(getCheerioImgFromMatch);
    const htmlMatchesToMediaItemNodesMap = await fetchNodeHtmlImageMediaItemNodes({
      cheerioImages,
      nodeString,
      node,
      helpers
    }); // generate gatsby images for each cheerioImage

    const htmlMatchesWithImageResizes = await Promise.all(imgTagMatches.map(async ({
      match
    }) => {
      var _imageNode$mediaDetai, _ref;

      const {
        imageNode,
        cheerioImg
      } = htmlMatchesToMediaItemNodesMap.get(match);
      const isMediaItemNode = imageNode.__typename === `MediaItem`;

      if (!imageNode) {
        return null;
      }

      const fileNode = // if we couldn't get a MediaItem node for this image in WPGQL
      !isMediaItemNode ? // this will already be a file node
      imageNode : // otherwise grab the file node
      helpers.getNode(imageNode.localFile.id);
      const imgTagMaxWidth = findImgTagMaxWidthFromCheerioImg(cheerioImg);
      const mediaItemNodeWidth = isMediaItemNode ? imageNode === null || imageNode === void 0 ? void 0 : (_imageNode$mediaDetai = imageNode.mediaDetails) === null || _imageNode$mediaDetai === void 0 ? void 0 : _imageNode$mediaDetai.width : null;
      const maxWidth = (_ref = mediaItemNodeWidth && mediaItemNodeWidth < imgTagMaxWidth ? mediaItemNodeWidth : // @todo add plugin option to configure default maxWidth
      imgTagMaxWidth) !== null && _ref !== void 0 ? _ref : 800;
      const fluidResult = await (0, _gatsbyPluginSharp.fluid)({
        file: fileNode,
        args: {
          maxWidth // @todo add plugin option to control quality

        },
        reporter: helpers.reporter,
        cache: helpers.cache
      });
      return {
        match,
        cheerioImg,
        fileNode,
        imageResize: fluidResult
      };
    })); // find/replace mutate nodeString to replace matched images with rendered gatsby images

    for (const {
      match,
      imageResize,
      cheerioImg
    } of htmlMatchesWithImageResizes) {
      // @todo retain img tag classes and attributes from cheerioImg
      const imgOptions = {
        fluid: imageResize,
        style: {
          maxWidth: "100%"
        } // // Force show full image instantly
        // // critical: true, // depricated
        // loading: "eager",
        // alt: formattedImgTag.alt,
        // // fadeIn: true,
        // imgStyle: {
        //   opacity: 1,
        // },

      };

      const ReactGatsbyImage = _react.default.createElement(_gatsbyImage.default, imgOptions, null);

      const gatsbyImageStringJSON = JSON.stringify(_server.default.renderToString(ReactGatsbyImage)); // need to remove the JSON stringify quotes around our image since we're
      // threading this JSON string back into a larger JSON object string

      const gatsbyImageString = gatsbyImageStringJSON.substring(1, gatsbyImageStringJSON.length - 1); // replace match with react string in nodeString

      nodeString = nodeString.replace(match, gatsbyImageString);
    }

    _store.default.dispatch.imageNodes.addImgMatches(imageUrlMatches);
  }

  return nodeString;
};

const processNodeString = async ({
  nodeString,
  node,
  pluginOptions,
  helpers,
  wpUrl
}) => {
  // const nodeStringFilters = [replaceNodeHtmlImages,]
  const nodeStringWithGatsbyImages = replaceNodeHtmlImages({
    nodeString,
    node,
    pluginOptions,
    helpers,
    wpUrl
  }); // const mediaItemNodes = await helpers.getNodesByType(`WpMediaItem`)
  // dd(mediaItemNodes)
  // const nodeStringWithGatsbyImagesAndRelativeLinks = replaceNodeHtmlLinks({
  //   nodeString,
  //   pluginOptions,
  // })
  // return nodeStringWithGatsbyImagesAndRelativeLinks

  return nodeStringWithGatsbyImages;
};

const processNode = async ({
  node,
  pluginOptions,
  referencedMediaItemNodeIds,
  wpUrl,
  helpers
}) => {
  const anchorTagRegex = new RegExp( // eslint-disable-next-line no-useless-escape
  `<a[\\\s]+[^>]*?href[\\\s]?=["'\\\\]*(${wpUrl}.*?)["'\\\\]*.*?>([^<]+|.*?)?<\/a>`, `gim`);
  const nodeString = (0, _fastJsonStableStringify.default)(node); // find referenced node ids

  const nodeMediaItemIdReferences = findReferencedImageNodeIds({
    nodeString,
    pluginOptions,
    node
  }); // push them to our store of referenced id's

  if (nodeMediaItemIdReferences.length) {
    nodeMediaItemIdReferences.forEach(id => referencedMediaItemNodeIds.add(id));
  }

  const processedNodeString = await processNodeString({
    nodeString,
    node,
    pluginOptions,
    helpers,
    wpUrl
  }); // only parse if the nodeString has changed

  if (processedNodeString !== nodeString) {
    try {
      return JSON.parse(processedNodeString);
    } catch (e) {
      (0, _dumper.dump)(processedNodeString);
      helpers.reporter.panic(e);
    }
  } else {
    return node;
  }
};

exports.processNode = processNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGVwcy9zb3VyY2Utbm9kZXMvY3JlYXRlLW5vZGVzL3Byb2Nlc3Mtbm9kZS5qcyJdLCJuYW1lcyI6WyJpbWdTcmNSZW1vdGVGaWxlUmVnZXgiLCJpbWdUYWdSZWdleCIsImZpbmRSZWZlcmVuY2VkSW1hZ2VOb2RlSWRzIiwibm9kZVN0cmluZyIsInBsdWdpbk9wdGlvbnMiLCJyZWZlcmVuY2VkTWVkaWFJdGVtTm9kZUlkcyIsIm5vZGUiLCJ0eXBlIiwiTWVkaWFJdGVtIiwibGF6eU5vZGVzIiwibWF0Y2hlZElkcyIsIm1hcCIsIm1hdGNoIiwic3ViTWF0Y2hlcyIsImZpbHRlciIsImlkIiwiZ2V0Q2hlZXJpb0ltZ0RiSWQiLCJjaGVlcmlvSW1nIiwiZGF0YUF0dHJpYnV0ZUlkIiwiYXR0cmlicyIsImNsYXNzIiwiZGJJZFRvTWVkaWFJdGVtUmVsYXlJZCIsImRiSWQiLCJnZXRDaGVlcmlvSW1nUmVsYXlJZCIsImZldGNoTm9kZUh0bWxJbWFnZU1lZGlhSXRlbU5vZGVzIiwiY2hlZXJpb0ltYWdlcyIsImhlbHBlcnMiLCJtZWRpYUl0ZW1VcmxzIiwic3JjIiwibWVkaWFJdGVtTm9kZXNCeVNvdXJjZVVybCIsIm1lZGlhSXRlbURiSWRzIiwiQm9vbGVhbiIsIm1lZGlhSXRlbVJlbGF5SWRzIiwicmVsYXlJZCIsImZpbmQiLCJtZWRpYUl0ZW1Ob2Rlc0J5SWQiLCJtZWRpYUl0ZW1Ob2RlcyIsImh0bWxNYXRjaGVzVG9NZWRpYUl0ZW1Ob2Rlc01hcCIsIk1hcCIsImh0bWxJbWdTcmMiLCJwb3NzaWJsZUh0bWxTcmNzIiwiaW1hZ2VOb2RlIiwibWVkaWFJdGVtTm9kZSIsImluY2x1ZGVzIiwic291cmNlVXJsIiwidXJsIiwicGFyZW50Tm9kZUlkIiwiY3JlYXRlTm9kZSIsImFjdGlvbnMiLCJzZXQiLCJnZXRDaGVlcmlvSW1nRnJvbU1hdGNoIiwicGFyc2VkTWF0Y2giLCJKU09OIiwicGFyc2UiLCIkIiwiY2hlZXJpbyIsImxvYWQiLCJ4bWwiLCJ3aXRoRG9tTHZsMSIsIm5vcm1hbGl6ZVdoaXRlc3BhY2UiLCJ4bWxNb2RlIiwiZGVjb2RlRW50aXRpZXMiLCJnZXRMYXJnZXN0U2l6ZUZyb21TaXplc0F0dHJpYnV0ZSIsInNpemVzU3RyaW5nIiwic2l6ZXNTdHJpbmdzQXJyYXkiLCJzcGxpdCIsInJlZHVjZSIsImxhcmdlc3QiLCJjdXJyZW50U2l6ZVN0cmluZyIsIm1heFdpZHRoIiwic3Vic3RyaW5nIiwiaW5kZXhPZiIsInRyaW0iLCJtYXhXaWR0aE51bWJlciIsIk51bWJlciIsIm5vTGFyZ2VzdEFuZE1heFdpZHRoSXNBTnVtYmVyIiwiaXNOYU4iLCJtYXhXaWR0aElzQUxhcmdlck51bWJlclRoYW5MYXJnZXN0IiwiZmluZEltZ1RhZ01heFdpZHRoRnJvbUNoZWVyaW9JbWciLCJ3aWR0aCIsInNpemVzIiwid2lkdGhOdW1iZXIiLCJsYXJnZXN0U2l6ZSIsInJlcGxhY2VOb2RlSHRtbEltYWdlcyIsIndwVXJsIiwiaW1hZ2VVcmxNYXRjaGVzIiwiaW1nVGFnTWF0Y2hlcyIsImxlbmd0aCIsImh0bWxNYXRjaGVzV2l0aEltYWdlUmVzaXplcyIsIlByb21pc2UiLCJhbGwiLCJnZXQiLCJpc01lZGlhSXRlbU5vZGUiLCJfX3R5cGVuYW1lIiwiZmlsZU5vZGUiLCJnZXROb2RlIiwibG9jYWxGaWxlIiwiaW1nVGFnTWF4V2lkdGgiLCJtZWRpYUl0ZW1Ob2RlV2lkdGgiLCJtZWRpYURldGFpbHMiLCJmbHVpZFJlc3VsdCIsImZpbGUiLCJhcmdzIiwicmVwb3J0ZXIiLCJjYWNoZSIsImltYWdlUmVzaXplIiwiaW1nT3B0aW9ucyIsImZsdWlkIiwic3R5bGUiLCJSZWFjdEdhdHNieUltYWdlIiwiUmVhY3QiLCJjcmVhdGVFbGVtZW50IiwiSW1nIiwiZ2F0c2J5SW1hZ2VTdHJpbmdKU09OIiwic3RyaW5naWZ5IiwiUmVhY3RET01TZXJ2ZXIiLCJyZW5kZXJUb1N0cmluZyIsImdhdHNieUltYWdlU3RyaW5nIiwicmVwbGFjZSIsInN0b3JlIiwiZGlzcGF0Y2giLCJpbWFnZU5vZGVzIiwiYWRkSW1nTWF0Y2hlcyIsInByb2Nlc3NOb2RlU3RyaW5nIiwibm9kZVN0cmluZ1dpdGhHYXRzYnlJbWFnZXMiLCJwcm9jZXNzTm9kZSIsImFuY2hvclRhZ1JlZ2V4IiwiUmVnRXhwIiwibm9kZU1lZGlhSXRlbUlkUmVmZXJlbmNlcyIsImZvckVhY2giLCJhZGQiLCJwcm9jZXNzZWROb2RlU3RyaW5nIiwiZSIsInBhbmljIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBRUE7QUFDQSxNQUFNQSxxQkFBcUIsR0FBRyxvcEJBQTlCO0FBRUEsTUFBTUMsV0FBVyxHQUFHLHlCQUFwQjs7QUFFQSxNQUFNQywwQkFBMEIsR0FBRyxDQUFDO0FBQ2xDQyxFQUFBQSxVQURrQztBQUVsQ0MsRUFBQUEsYUFGa0M7QUFHbENDLEVBQUFBLDBCQUhrQztBQUlsQ0MsRUFBQUE7QUFKa0MsQ0FBRCxLQUs3QjtBQUNKO0FBQ0E7QUFDQSxNQUFJRixhQUFhLENBQUNHLElBQWQsQ0FBbUJDLFNBQW5CLENBQTZCQyxTQUFqQyxFQUE0QztBQUMxQztBQUNELEdBTEcsQ0FPSjs7O0FBQ0EsUUFBTUMsVUFBVSxHQUFHLHNCQUFRLDhCQUFSLEVBQXdDUCxVQUF4QyxFQUNoQlEsR0FEZ0IsQ0FDWEMsS0FBRCxJQUFXQSxLQUFLLENBQUNDLFVBQU4sQ0FBaUIsQ0FBakIsQ0FEQyxFQUVoQkMsTUFGZ0IsQ0FFUkMsRUFBRCxJQUFRQSxFQUFFLEtBQUtULElBQUksQ0FBQ1MsRUFGWCxDQUFuQjtBQUlBLFNBQU9MLFVBQVA7QUFDRCxDQWxCRDs7QUFvQkEsTUFBTU0saUJBQWlCLEdBQUlDLFVBQUQsSUFBZ0I7QUFDeEM7QUFDQSxRQUFNQyxlQUFlLEdBQ25CRCxVQUFVLENBQUNFLE9BQVgsQ0FBb0IsU0FBcEIsS0FBaUNGLFVBQVUsQ0FBQ0UsT0FBWCxDQUFvQixlQUFwQixDQURu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LEtBQUtoSSxVQUE1QixFQUF3QztBQUN0QyxRQUFJO0FBQ0YsYUFBT2lELElBQUksQ0FBQ0MsS0FBTCxDQUFXOEUsbUJBQVgsQ0FBUDtBQUNELEtBRkQsQ0FFRSxPQUFPQyxDQUFQLEVBQVU7QUFDVix3QkFBS0QsbUJBQUw7QUFDQXpHLE1BQUFBLE9BQU8sQ0FBQzZFLFFBQVIsQ0FBaUI4QixLQUFqQixDQUF1QkQsQ0FBdkI7QUFDRDtBQUNGLEdBUEQsTUFPTztBQUNMLFdBQU85SCxJQUFQO0FBQ0Q7QUFDRixDQWhERCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZsdWlkIH0gZnJvbSBcImdhdHNieS1wbHVnaW4tc2hhcnBcIlxuaW1wb3J0IEltZyBmcm9tIFwiZ2F0c2J5LWltYWdlXCJcbmltcG9ydCBSZWFjdCBmcm9tIFwicmVhY3RcIlxuaW1wb3J0IFJlYWN0RE9NU2VydmVyIGZyb20gXCJyZWFjdC1kb20vc2VydmVyXCJcbmltcG9ydCBzdHJpbmdpZnkgZnJvbSBcImZhc3QtanNvbi1zdGFibGUtc3RyaW5naWZ5XCJcbmltcG9ydCBleGVjYWxsIGZyb20gXCJleGVjYWxsXCJcbmltcG9ydCBjaGVlcmlvIGZyb20gXCJjaGVlcmlvXCJcblxuaW1wb3J0IGNyZWF0ZVJlbW90ZUZpbGVOb2RlIGZyb20gXCIuL2NyZWF0ZS1yZW1vdGUtZmlsZS1ub2RlL2luZGV4XCJcbmltcG9ydCBmZXRjaFJlZmVyZW5jZWRNZWRpYUl0ZW1zQW5kQ3JlYXRlTm9kZXMsIHtcbiAgc3RyaXBJbWFnZVNpemVzRnJvbVVybCxcbn0gZnJvbSBcIi4uL2ZldGNoLW5vZGVzL2ZldGNoLXJlZmVyZW5jZWQtbWVkaWEtaXRlbXNcIlxuaW1wb3J0IHN0b3JlIGZyb20gXCJ+L3N0b3JlXCJcbmltcG9ydCBidG9hIGZyb20gXCJidG9hXCJcblxuLy8gQHRvZG8gdGhpcyBkb2Vzbid0IG1ha2Ugc2Vuc2UgYmVjYXVzZSB0aGVzZSBhcmVuJ3QgYWxsIGltYWdlc1xuY29uc3QgaW1nU3JjUmVtb3RlRmlsZVJlZ2V4ID0gLyg/OnNyYz1cXFxcXCIpKCg/Oig/Omh0dHBzP3xmdHB8ZmlsZSk6XFwvXFwvfHd3d1xcLnxmdHBcXC4pKD86XFwoWy1BLVowLTkrJkAjLyU9fl98JD8hOiwuXSpcXCl8Wy1BLVowLTkrJkAjLyU9fl98JD8hOiwuXSkqKD86XFwoWy1BLVowLTkrJkAjLyU9fl98JD8hOiwuXSpcXCl8W0EtWjAtOSsmQCMvJT1+X3wkXSlcXC4oPzp4anBlZ3xqcGd8cG5nfGdpZnxpY298cGRmfGRvY3xkb2N4fHBwdHxwcHR4fHBwc3xwcHN4fG9kdHx4bHN8cHNkfG1wM3xtNGF8b2dnfHdhdnxtcDR8bTR2fG1vdnx3bXZ8YXZpfG1wZ3xvZ3Z8M2dwfDNnMnxzdmd8Ym1wfHRpZnx0aWZmfGFzZnxhc3h8d218d214fGRpdnh8Zmx2fHF0fG1wZXx3ZWJtfG1rdnx0dHxhc2N8Y3xjY3xofGNzdnx0c3Z8aWNzfHJ0eHxjc3N8aHRtfGh0bWx8bTRifHJhfHJhbXxtaWR8bWlkaXx3YXh8bWthfHJ0Znxqc3xzd2Z8Y2xhc3N8dGFyfHppcHxnenxnemlwfHJhcnw3enxleGV8cG90fHdyaXx4bGF8eGx0fHhsd3xtZGJ8bXBwfGRvY218ZG90eHxkb3RtfHhsc218eGxzYnx4bHR4fHhsdG18eGxhbXxwcHRtfHBwc218cG90eHxwb3RtfHBwYW18c2xkeHxzbGRtfG9uZXRvY3xvbmV0b2MyfG9uZXRtcHxvbmVwa2d8b2RwfG9kc3xvZGd8b2RjfG9kYnxvZGZ8d3B8d3BkfGtleXxudW1iZXJzfHBhZ2VzKSkoPz1cXFxcXCJ8IHxcXC4pL2dpbVxuXG5jb25zdCBpbWdUYWdSZWdleCA9IC88aW1nKFtcXHdcXFddKz8pW1xcL10/Pi9naW1cblxuY29uc3QgZmluZFJlZmVyZW5jZWRJbWFnZU5vZGVJZHMgPSAoe1xuICBub2RlU3RyaW5nLFxuICBwbHVnaW5PcHRpb25zLFxuICByZWZlcmVuY2VkTWVkaWFJdGVtTm9kZUlkcyxcbiAgbm9kZSxcbn0pID0+IHtcbiAgLy8gaWYgdGhlIGxhenlOb2RlcyBwbHVnaW4gb3B0aW9uIGlzIHNldCB3ZSBkb24ndCBuZWVkIHRvIGZpbmRcbiAgLy8gaW1hZ2Ugbm9kZSBpZCdzIGJlY2F1c2UgdGhvc2Ugbm9kZXMgd2lsbCBiZSBmZXRjaGVkIGxhemlseSBpbiByZXNvbHZlcnNcbiAgaWYgKHBsdWdpbk9wdGlvbnMudHlwZS5NZWRpYUl0ZW0ubGF6eU5vZGVzKSB7XG4gICAgcmV0dXJuXG4gIH1cblxuICAvLyBnZXQgYW4gYXJyYXkgb2YgYWxsIHJlZmVyZW5jZWQgbWVkaWEgZmlsZSBJRCdzXG4gIGNvbnN0IG1hdGNoZWRJZHMgPSBleGVjYWxsKC9cImlkXCI6XCIoW15cIl0qKVwiLFwic291cmNlVXJsXCIvZ20sIG5vZGVTdHJpbmcpXG4gICAgLm1hcCgobWF0Y2gpID0+IG1hdGNoLnN1Yk1hdGNoZXNbMF0pXG4gICAgLmZpbHRlcigoaWQpID0+IGlkICE9PSBub2RlLmlkKVxuXG4gIHJldHVybiBtYXRjaGVkSWRzXG59XG5cbmNvbnN0IGdldENoZWVyaW9JbWdEYklkID0gKGNoZWVyaW9JbWcpID0+IHtcbiAgLy8gdHJ5IHRvIGdldCB0aGUgZGIgaWQgZnJvbSBkYXRhIGF0dHJpYnV0ZXNcbiAgY29uc3QgZGF0YUF0dHJpYnV0ZUlkID1cbiAgICBjaGVlcmlvSW1nLmF0dHJpYnNbYGRhdGEtaWRgXSB8fCBjaGVlcmlvSW1nLmF0dHJpYnNbYGRhdGEtaW1hZ2UtaWRgXVxuXG4gIGlmIChkYXRhQXR0cmlidXRlSWQpIHtcbiAgICByZXR1cm4gZGF0YUF0dHJpYnV0ZUlkXG4gIH1cblxuICBpZiAoIWNoZWVyaW9JbWcuYXR0cmlicy5jbGFzcykge1xuICAgIHJldHVybiBudWxsXG4gIH1cblxuICAvLyB0cnkgdG8gZ2V0IHRoZSBkYiBpZCBmcm9tIHRoZSB3cC1pbWFnZS1pZCBjbGFzc25hbWVcbiAgLy8gY29uc3Qgd3BJbWFnZUNsYXNzID0gY2hlZXJpb0ltZy5hdHRyaWJzLmNsYXNzXG4gIC8vICAgLnNwbGl0KGAgYClcbiAgLy8gICAuZmluZCgoY2xhc3NOYW1lKSA9PiBjbGFzc05hbWUuaW5jbHVkZXMoYHdwLWltYWdlLWApKVxuXG4gIC8vIGlmICh3cEltYWdlQ2xhc3MpIHtcbiAgLy8gICBjb25zdCB3cEltYWdlQ2xhc3NEYXNoQXJyYXkgPSB3cEltYWdlQ2xhc3Muc3BsaXQoYC1gKVxuICAvLyAgIGNvbnN0IHdwSW1hZ2VDbGFzc0lkID0gTnVtYmVyKFxuICAvLyAgICAgd3BJbWFnZUNsYXNzRGFzaEFycmF5W3dwSW1hZ2VDbGFzc0Rhc2hBcnJheS5sZW5ndGggLSAxXVxuICAvLyAgIClcblxuICAvLyAgIGlmICh3cEltYWdlQ2xhc3NJZCkge1xuICAvLyAgICAgcmV0dXJuIHdwSW1hZ2VDbGFzc0lkXG4gIC8vICAgfVxuICAvLyB9XG5cbiAgcmV0dXJuIG51bGxcbn1cblxuY29uc3QgZGJJZFRvTWVkaWFJdGVtUmVsYXlJZCA9IChkYklkKSA9PiAoZGJJZCA/IGJ0b2EoYHBvc3Q6JHtkYklkfWApIDogbnVsbClcblxuY29uc3QgZ2V0Q2hlZXJpb0ltZ1JlbGF5SWQgPSAoY2hlZXJpb0ltZykgPT5cbiAgZGJJZFRvTWVkaWFJdGVtUmVsYXlJZChnZXRDaGVlcmlvSW1nRGJJZChjaGVlcmlvSW1nKSlcblxuY29uc3QgZmV0Y2hOb2RlSHRtbEltYWdlTWVkaWFJdGVtTm9kZXMgPSBhc3luYyAoe1xuICBjaGVlcmlvSW1hZ2VzLFxuICBub2RlU3RyaW5nLFxuICBub2RlLFxuICBoZWxwZXJzLFxufSkgPT4ge1xuICAvLyBjaGVjayBpZiB3ZSBoYXZlIGFueSBvZiB0aGVzZSBub2RlcyBsb2NhbGx5IGFscmVhZHlcbiAgLy8gYnVpbGQgYSBxdWVyeSB0byBmZXRjaCBhbGwgbWVkaWEgaXRlbXMgdGhhdCB3ZSBkb24ndCBhbHJlYWR5IGhhdmVcbiAgY29uc3QgbWVkaWFJdGVtVXJscyA9IGNoZWVyaW9JbWFnZXMubWFwKFxuICAgICh7IGNoZWVyaW9JbWcgfSkgPT4gY2hlZXJpb0ltZy5hdHRyaWJzLnNyY1xuICApXG5cbiAgY29uc3QgbWVkaWFJdGVtTm9kZXNCeVNvdXJjZVVybCA9IGF3YWl0IGZldGNoUmVmZXJlbmNlZE1lZGlhSXRlbXNBbmRDcmVhdGVOb2RlcyhcbiAgICB7XG4gICAgICBtZWRpYUl0ZW1VcmxzLFxuICAgIH1cbiAgKVxuXG4gIC8vIGltYWdlcyB0aGF0IGhhdmUgYmVlbiBlZGl0ZWQgZnJvbSB0aGUgbWVkaWEgbGlicmFyeSB0aGF0IHdlcmUgcHJldmlvdXNseVxuICAvLyB1cGxvYWRlZCB0byBhIHBvc3QvcGFnZSB3aWxsIGhhdmUgYSBkaWZmZXJlbnQgc291cmNlVXJsIHNvIHRoZXkgY2FuJ3QgYmUgZmV0Y2hlZCBieSBpdFxuICAvLyBpbiBtYW55IGNhc2VzIHdlIGhhdmUgZGF0YS1pZCBvciBkYXRhLWltYWdlLWlkIGFzIGF0dHJpYnV0ZXMgb24gdGhlIGltZ1xuICAvLyB3ZSBjYW4gdHJ5IHRvIHVzZSB0aG9zZSB0byBmZXRjaCBtZWRpYSBpdGVtIG5vZGVzIGFzIHdlbGxcbiAgLy8gdGhpcyB3aWxsIGtlZXAgdXMgZnJvbSBtaXNzaW5nIG5vZGVzXG4gIGNvbnN0IG1lZGlhSXRlbURiSWRzID0gY2hlZXJpb0ltYWdlc1xuICAgIC5tYXAoKHsgY2hlZXJpb0ltZyB9KSA9PiBnZXRDaGVlcmlvSW1nRGJJZChjaGVlcmlvSW1nKSlcbiAgICAuZmlsdGVyKEJvb2xlYW4pXG5cbiAgLy8gbWVkaWEgaXRlbXMgYXJlIG9mIHRoZSBwb3N0IHR5cGVcbiAgY29uc3QgbWVkaWFJdGVtUmVsYXlJZHMgPSBtZWRpYUl0ZW1EYklkc1xuICAgIC5tYXAoKGRiSWQpID0+IGRiSWRUb01lZGlhSXRlbVJlbGF5SWQoZGJJZCkpXG4gICAgLmZpbHRlcihcbiAgICAgIC8vIGZpbHRlciBvdXQgYW55IG1lZGlhIGl0ZW0gaWRzIHdlIGFscmVhZHkgZmV0Y2hlZFxuICAgICAgKHJlbGF5SWQpID0+ICFtZWRpYUl0ZW1Ob2Rlc0J5U291cmNlVXJsLmZpbmQoKHsgaWQgfSkgPT4gaWQgPT09IHJlbGF5SWQpXG4gICAgKVxuXG4gIGNvbnN0IG1lZGlhSXRlbU5vZGVzQnlJZCA9IGF3YWl0IGZldGNoUmVmZXJlbmNlZE1lZGlhSXRlbXNBbmRDcmVhdGVOb2Rlcyh7XG4gICAgcmVmZXJlbmNlZE1lZGlhSXRlbU5vZGVJZHM6IG1lZGlhSXRlbVJlbGF5SWRzLFxuICB9KVxuXG4gIGNvbnN0IG1lZGlhSXRlbU5vZGVzID0gWy4uLm1lZGlhSXRlbU5vZGVzQnlJZCwgLi4ubWVkaWFJdGVtTm9kZXNCeVNvdXJjZVVybF1cblxuICBjb25zdCBodG1sTWF0Y2hlc1RvTWVkaWFJdGVtTm9kZXNNYXAgPSBuZXcgTWFwKClcbiAgZm9yIChjb25zdCB7IGNoZWVyaW9JbWcsIG1hdGNoIH0gb2YgY2hlZXJpb0ltYWdlcykge1xuICAgIGNvbnN0IGh0bWxJbWdTcmMgPSBjaGVlcmlvSW1nLmF0dHJpYnMuc3JjXG5cbiAgICBjb25zdCBwb3NzaWJsZUh0bWxTcmNzID0gW1xuICAgICAgLy8gdHJ5IHRvIG1hdGNoIHRoZSBtZWRpYSBpdGVtIHNvdXJjZSB1cmwgYnkgb3JpZ2luYWwgaHRtbCBzcmNcbiAgICAgIGh0bWxJbWdTcmMsXG4gICAgICAvLyBvciBieSB0aGUgc3JjIG1pbnVzIGFueSBpbWFnZSBzaXplcyBzdHJpbmdcbiAgICAgIHN0cmlwSW1hZ2VTaXplc0Zyb21VcmwoaHRtbEltZ1NyYyksXG4gICAgXVxuXG4gICAgbGV0IGltYWdlTm9kZSA9IG1lZGlhSXRlbU5vZGVzLmZpbmQoXG4gICAgICAobWVkaWFJdGVtTm9kZSkgPT5cbiAgICAgICAgLy8gZWl0aGVyIGZpbmQgb3VyIG5vZGUgYnkgdGhlIHNvdXJjZSB1cmxcbiAgICAgICAgcG9zc2libGVIdG1sU3Jjcy5pbmNsdWRlcyhtZWRpYUl0ZW1Ob2RlLnNvdXJjZVVybCkgfHxcbiAgICAgICAgLy8gb3IgYnkgaWQgZm9yIGNhc2VzIHdoZXJlIHRoZSBzcmMgdXJsIGRpZG4ndCByZXR1cm4gYSBub2RlXG4gICAgICAgIGdldENoZWVyaW9JbWdSZWxheUlkKGNoZWVyaW9JbWcpID09PSBtZWRpYUl0ZW1Ob2RlLmlkXG4gICAgKVxuXG4gICAgaWYgKCFpbWFnZU5vZGUgJiYgaHRtbEltZ1NyYykge1xuICAgICAgLy8gaWYgd2UgZGlkbid0IGdldCBhIG1lZGlhIGl0ZW0gbm9kZSBmb3IgdGhpcyBpbWFnZSxcbiAgICAgIC8vIHdlIG5lZWQgdG8gZmV0Y2ggaXQgYW5kIGNyZWF0ZSBhIGZpbGUgbm9kZSBmb3IgaXQgd2l0aCBub1xuICAgICAgLy8gbWVkaWEgaXRlbSBub2RlLlxuICAgICAgaW1hZ2VOb2RlID0gYXdhaXQgY3JlYXRlUmVtb3RlRmlsZU5vZGUoe1xuICAgICAgICB1cmw6IGh0bWxJbWdTcmMsXG4gICAgICAgIC8vIGZpeGVkQmFyVG90YWwsXG4gICAgICAgIHBhcmVudE5vZGVJZDogbm9kZS5pZCxcbiAgICAgICAgLi4uaGVscGVycyxcbiAgICAgICAgY3JlYXRlTm9kZTogaGVscGVycy5hY3Rpb25zLmNyZWF0ZU5vZGUsXG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmIChpbWFnZU5vZGUpIHtcbiAgICAgIC8vIG1hdGNoIGlzIHRoZSBodG1sIHN0cmluZyBvZiB0aGUgaW1nIHRhZ1xuICAgICAgaHRtbE1hdGNoZXNUb01lZGlhSXRlbU5vZGVzTWFwLnNldChtYXRjaCwgeyBpbWFnZU5vZGUsIGNoZWVyaW9JbWcgfSlcbiAgICB9XG4gIH1cblxuICByZXR1cm4gaHRtbE1hdGNoZXNUb01lZGlhSXRlbU5vZGVzTWFwXG59XG5cbmNvbnN0IGdldENoZWVyaW9JbWdGcm9tTWF0Y2ggPSAoeyBtYXRjaCB9KSA9PiB7XG4gIC8vIHVuZXNjYXBlIHF1b3Rlc1xuICBjb25zdCBwYXJzZWRNYXRjaCA9IEpTT04ucGFyc2UoYFwiJHttYXRjaH1cImApXG5cbiAgLy8gbG9hZCBvdXIgbWF0Y2hpbmcgaW1nIHRhZyBpbnRvIGNoZWVyaW9cbiAgY29uc3QgJCA9IGNoZWVyaW8ubG9hZChwYXJzZWRNYXRjaCwge1xuICAgIHhtbDoge1xuICAgICAgLy8gbWFrZSBzdXJlIGl0J3Mgbm90IHdyYXBwZWQgaW4gPGJvZHk+PC9ib2R5PlxuICAgICAgd2l0aERvbUx2bDE6IGZhbHNlLFxuICAgICAgLy8gbm8gbmVlZCB0byBub3JtYWxpemUgd2hpdGVzcGFjZSwgd2UncmUgZGVhbGluZyB3aXRoIGEgc2luZ2xlIGVsZW1lbnQgaGVyZVxuICAgICAgbm9ybWFsaXplV2hpdGVzcGFjZTogZmFsc2UsXG4gICAgICB4bWxNb2RlOiB0cnVlLFxuICAgICAgLy8gZW50aXR5IGRlY29kaW5nIGlzbid0IG91ciBqb2IgaGVyZSwgdGhhdCB3aWxsIGJlIHRoZSByZXNwb25zaWJpbGl0eSBvZiBXUEdRTFxuICAgICAgLy8gb3Igb2YgdGhlIHNvdXJjZSBwbHVnaW4gZWxzZXdoZXJlLlxuICAgICAgZGVjb2RlRW50aXRpZXM6IGZhbHNlLFxuICAgIH0sXG4gIH0pXG5cbiAgLy8gdGhlcmUncyBvbmx5IGV2ZXIgb25lIGltYWdlIGR1ZSB0byBvdXIgbWF0Y2ggbWF0Y2hpbmcgYSBzaW5nbGUgaW1nIHRhZ1xuICAvLyAkKGBpbWdgKSBpc24ndCBhbiBhcnJheSwgaXQncyBhbiBvYmplY3Qgd2l0aCBhIGtleSBvZiAwXG4gIGNvbnN0IGNoZWVyaW9JbWcgPSAkKGBpbWdgKVswXVxuXG4gIHJldHVybiB7XG4gICAgbWF0Y2gsXG4gICAgY2hlZXJpb0ltZyxcbiAgfVxufVxuXG5jb25zdCBnZXRMYXJnZXN0U2l6ZUZyb21TaXplc0F0dHJpYnV0ZSA9IChzaXplc1N0cmluZykgPT4ge1xuICBjb25zdCBzaXplc1N0cmluZ3NBcnJheSA9IHNpemVzU3RyaW5nLnNwbGl0KGAsYClcblxuICByZXR1cm4gc2l6ZXNTdHJpbmdzQXJyYXkucmVkdWNlKChsYXJnZXN0LCBjdXJyZW50U2l6ZVN0cmluZykgPT4ge1xuICAgIGNvbnN0IG1heFdpZHRoID0gY3VycmVudFNpemVTdHJpbmdcbiAgICAgIC5zdWJzdHJpbmcoXG4gICAgICAgIGN1cnJlbnRTaXplU3RyaW5nLmluZGV4T2YoYG1heC13aWR0aDogYCkgKyAxLFxuICAgICAgICBjdXJyZW50U2l6ZVN0cmluZy5pbmRleE9mKGBweGApXG4gICAgICApXG4gICAgICAudHJpbSgpXG5cbiAgICBjb25zdCBtYXhXaWR0aE51bWJlciA9IE51bWJlcihtYXhXaWR0aClcbiAgICBjb25zdCBub0xhcmdlc3RBbmRNYXhXaWR0aElzQU51bWJlciA9ICFsYXJnZXN0ICYmICFpc05hTihtYXhXaWR0aE51bWJlcilcbiAgICBjb25zdCBtYXhXaWR0aElzQUxhcmdlck51bWJlclRoYW5MYXJnZXN0ID1cbiAgICAgIGxhcmdlc3QgJiYgIWlzTmFOKG1heFdpZHRoTnVtYmVyKSAmJiBtYXhXaWR0aE51bWJlciA+IGxhcmdlc3RcblxuICAgIGlmIChub0xhcmdlc3RBbmRNYXhXaWR0aElzQU51bWJlciB8fCBtYXhXaWR0aElzQUxhcmdlck51bWJlclRoYW5MYXJnZXN0KSB7XG4gICAgICBsYXJnZXN0ID0gbWF4V2lkdGhOdW1iZXJcbiAgICB9XG5cbiAgICByZXR1cm4gbGFyZ2VzdFxuICB9LCBudWxsKVxufVxuXG5jb25zdCBmaW5kSW1nVGFnTWF4V2lkdGhGcm9tQ2hlZXJpb0ltZyA9IChjaGVlcmlvSW1nKSA9PiB7XG4gIGNvbnN0IHtcbiAgICBhdHRyaWJzOiB7IHdpZHRoLCBzaXplcyB9LFxuICB9ID0gY2hlZXJpb0ltZyB8fCB7IGF0dHJpYnM6IHsgd2lkdGg6IG51bGwsIHNpemVzOiBudWxsIH0gfVxuXG4gIGlmICh3aWR0aCkge1xuICAgIGNvbnN0IHdpZHRoTnVtYmVyID0gTnVtYmVyKHdpZHRoKVxuXG4gICAgaWYgKCFpc05hTih3aWR0aE51bWJlcikpIHtcbiAgICAgIHJldHVybiB3aWR0aFxuICAgIH1cbiAgfVxuXG4gIGlmIChzaXplcykge1xuICAgIGNvbnN0IGxhcmdlc3RTaXplID0gZ2V0TGFyZ2VzdFNpemVGcm9tU2l6ZXNBdHRyaWJ1dGUoc2l6ZXMpXG5cbiAgICBpZiAobGFyZ2VzdFNpemUgJiYgIWlzTmFOKGxhcmdlc3RTaXplKSkge1xuICAgICAgcmV0dXJuIGxhcmdlc3RTaXplXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG51bGxcbn1cblxuY29uc3QgcmVwbGFjZU5vZGVIdG1sSW1hZ2VzID0gYXN5bmMgKHtcbiAgbm9kZVN0cmluZyxcbiAgbm9kZSxcbiAgaGVscGVycyxcbiAgd3BVcmwsXG4gIC8vIHBsdWdpbk9wdGlvbnMsXG59KSA9PiB7XG4gIGNvbnN0IGltYWdlVXJsTWF0Y2hlcyA9IGV4ZWNhbGwoaW1nU3JjUmVtb3RlRmlsZVJlZ2V4LCBub2RlU3RyaW5nKVxuICBjb25zdCBpbWdUYWdNYXRjaGVzID0gZXhlY2FsbChpbWdUYWdSZWdleCwgbm9kZVN0cmluZykuZmlsdGVyKCh7IG1hdGNoIH0pID0+XG4gICAgLy8gQHRvZG8gbWFrZSBpdCBhIHBsdWdpbiBvcHRpb24gdG8gZmV0Y2ggbm9uLXdwIGltYWdlc1xuICAgIC8vIGhlcmUgd2UncmUgZmlsdGVyaW5nIG91dCBpbWFnZSB0YWdzIHRoYXQgZG9uJ3QgY29udGFpbiBvdXIgc2l0ZSB1cmxcbiAgICBtYXRjaC5pbmNsdWRlcyh3cFVybClcbiAgKVxuXG4gIGlmIChpbWFnZVVybE1hdGNoZXMubGVuZ3RoKSB7XG4gICAgY29uc3QgY2hlZXJpb0ltYWdlcyA9IGltZ1RhZ01hdGNoZXMubWFwKGdldENoZWVyaW9JbWdGcm9tTWF0Y2gpXG5cbiAgICBjb25zdCBodG1sTWF0Y2hlc1RvTWVkaWFJdGVtTm9kZXNNYXAgPSBhd2FpdCBmZXRjaE5vZGVIdG1sSW1hZ2VNZWRpYUl0ZW1Ob2RlcyhcbiAgICAgIHtcbiAgICAgICAgY2hlZXJpb0ltYWdlcyxcbiAgICAgICAgbm9kZVN0cmluZyxcbiAgICAgICAgbm9kZSxcbiAgICAgICAgaGVscGVycyxcbiAgICAgIH1cbiAgICApXG5cbiAgICAvLyBnZW5lcmF0ZSBnYXRzYnkgaW1hZ2VzIGZvciBlYWNoIGNoZWVyaW9JbWFnZVxuICAgIGNvbnN0IGh0bWxNYXRjaGVzV2l0aEltYWdlUmVzaXplcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgaW1nVGFnTWF0Y2hlcy5tYXAoYXN5bmMgKHsgbWF0Y2ggfSkgPT4ge1xuICAgICAgICBjb25zdCB7IGltYWdlTm9kZSwgY2hlZXJpb0ltZyB9ID0gaHRtbE1hdGNoZXNUb01lZGlhSXRlbU5vZGVzTWFwLmdldChcbiAgICAgICAgICBtYXRjaFxuICAgICAgICApXG5cbiAgICAgICAgY29uc3QgaXNNZWRpYUl0ZW1Ob2RlID0gaW1hZ2VOb2RlLl9fdHlwZW5hbWUgPT09IGBNZWRpYUl0ZW1gXG5cbiAgICAgICAgaWYgKCFpbWFnZU5vZGUpIHtcbiAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZmlsZU5vZGUgPVxuICAgICAgICAgIC8vIGlmIHdlIGNvdWxkbid0IGdldCBhIE1lZGlhSXRlbSBub2RlIGZvciB0aGlzIGltYWdlIGluIFdQR1FMXG4gICAgICAgICAgIWlzTWVkaWFJdGVtTm9kZVxuICAgICAgICAgICAgPyAvLyB0aGlzIHdpbGwgYWxyZWFkeSBiZSBhIGZpbGUgbm9kZVxuICAgICAgICAgICAgICBpbWFnZU5vZGVcbiAgICAgICAgICAgIDogLy8gb3RoZXJ3aXNlIGdyYWIgdGhlIGZpbGUgbm9kZVxuICAgICAgICAgICAgICBoZWxwZXJzLmdldE5vZGUoaW1hZ2VOb2RlLmxvY2FsRmlsZS5pZClcblxuICAgICAgICBjb25zdCBpbWdUYWdNYXhXaWR0aCA9IGZpbmRJbWdUYWdNYXhXaWR0aEZyb21DaGVlcmlvSW1nKGNoZWVyaW9JbWcpXG4gICAgICAgIGNvbnN0IG1lZGlhSXRlbU5vZGVXaWR0aCA9IGlzTWVkaWFJdGVtTm9kZVxuICAgICAgICAgID8gaW1hZ2VOb2RlPy5tZWRpYURldGFpbHM/LndpZHRoXG4gICAgICAgICAgOiBudWxsXG5cbiAgICAgICAgY29uc3QgbWF4V2lkdGggPVxuICAgICAgICAgIChtZWRpYUl0ZW1Ob2RlV2lkdGggJiYgbWVkaWFJdGVtTm9kZVdpZHRoIDwgaW1nVGFnTWF4V2lkdGhcbiAgICAgICAgICAgID8gbWVkaWFJdGVtTm9kZVdpZHRoXG4gICAgICAgICAgICA6IC8vIEB0b2RvIGFkZCBwbHVnaW4gb3B0aW9uIHRvIGNvbmZpZ3VyZSBkZWZhdWx0IG1heFdpZHRoXG4gICAgICAgICAgICAgIGltZ1RhZ01heFdpZHRoKSA/PyA4MDBcblxuICAgICAgICBjb25zdCBmbHVpZFJlc3VsdCA9IGF3YWl0IGZsdWlkKHtcbiAgICAgICAgICBmaWxlOiBmaWxlTm9kZSxcbiAgICAgICAgICBhcmdzOiB7XG4gICAgICAgICAgICBtYXhXaWR0aCxcbiAgICAgICAgICAgIC8vIEB0b2RvIGFkZCBwbHVnaW4gb3B0aW9uIHRvIGNvbnRyb2wgcXVhbGl0eVxuICAgICAgICAgIH0sXG4gICAgICAgICAgcmVwb3J0ZXI6IGhlbHBlcnMucmVwb3J0ZXIsXG4gICAgICAgICAgY2FjaGU6IGhlbHBlcnMuY2FjaGUsXG4gICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtYXRjaCxcbiAgICAgICAgICBjaGVlcmlvSW1nLFxuICAgICAgICAgIGZpbGVOb2RlLFxuICAgICAgICAgIGltYWdlUmVzaXplOiBmbHVpZFJlc3VsdCxcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApXG5cbiAgICAvLyBmaW5kL3JlcGxhY2UgbXV0YXRlIG5vZGVTdHJpbmcgdG8gcmVwbGFjZSBtYXRjaGVkIGltYWdlcyB3aXRoIHJlbmRlcmVkIGdhdHNieSBpbWFnZXNcbiAgICBmb3IgKGNvbnN0IHtcbiAgICAgIG1hdGNoLFxuICAgICAgaW1hZ2VSZXNpemUsXG4gICAgICBjaGVlcmlvSW1nLFxuICAgIH0gb2YgaHRtbE1hdGNoZXNXaXRoSW1hZ2VSZXNpemVzKSB7XG4gICAgICAvLyBAdG9kbyByZXRhaW4gaW1nIHRhZyBjbGFzc2VzIGFuZCBhdHRyaWJ1dGVzIGZyb20gY2hlZXJpb0ltZ1xuICAgICAgY29uc3QgaW1nT3B0aW9ucyA9IHtcbiAgICAgICAgZmx1aWQ6IGltYWdlUmVzaXplLFxuICAgICAgICBzdHlsZToge1xuICAgICAgICAgIG1heFdpZHRoOiBcIjEwMCVcIixcbiAgICAgICAgfSxcbiAgICAgICAgLy8gLy8gRm9yY2Ugc2hvdyBmdWxsIGltYWdlIGluc3RhbnRseVxuICAgICAgICAvLyAvLyBjcml0aWNhbDogdHJ1ZSwgLy8gZGVwcmljYXRlZFxuICAgICAgICAvLyBsb2FkaW5nOiBcImVhZ2VyXCIsXG4gICAgICAgIC8vIGFsdDogZm9ybWF0dGVkSW1nVGFnLmFsdCxcbiAgICAgICAgLy8gLy8gZmFkZUluOiB0cnVlLFxuICAgICAgICAvLyBpbWdTdHlsZToge1xuICAgICAgICAvLyAgIG9wYWNpdHk6IDEsXG4gICAgICAgIC8vIH0sXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IFJlYWN0R2F0c2J5SW1hZ2UgPSBSZWFjdC5jcmVhdGVFbGVtZW50KEltZywgaW1nT3B0aW9ucywgbnVsbClcbiAgICAgIGNvbnN0IGdhdHNieUltYWdlU3RyaW5nSlNPTiA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICBSZWFjdERPTVNlcnZlci5yZW5kZXJUb1N0cmluZyhSZWFjdEdhdHNieUltYWdlKVxuICAgICAgKVxuXG4gICAgICAvLyBuZWVkIHRvIHJlbW92ZSB0aGUgSlNPTiBzdHJpbmdpZnkgcXVvdGVzIGFyb3VuZCBvdXIgaW1hZ2Ugc2luY2Ugd2UncmVcbiAgICAgIC8vIHRocmVhZGluZyB0aGlzIEpTT04gc3RyaW5nIGJhY2sgaW50byBhIGxhcmdlciBKU09OIG9iamVjdCBzdHJpbmdcbiAgICAgIGNvbnN0IGdhdHNieUltYWdlU3RyaW5nID0gZ2F0c2J5SW1hZ2VTdHJpbmdKU09OLnN1YnN0cmluZyhcbiAgICAgICAgMSxcbiAgICAgICAgZ2F0c2J5SW1hZ2VTdHJpbmdKU09OLmxlbmd0aCAtIDFcbiAgICAgIClcblxuICAgICAgLy8gcmVwbGFjZSBtYXRjaCB3aXRoIHJlYWN0IHN0cmluZyBpbiBub2RlU3RyaW5nXG4gICAgICBub2RlU3RyaW5nID0gbm9kZVN0cmluZy5yZXBsYWNlKG1hdGNoLCBnYXRzYnlJbWFnZVN0cmluZylcbiAgICB9XG5cbiAgICBzdG9yZS5kaXNwYXRjaC5pbWFnZU5vZGVzLmFkZEltZ01hdGNoZXMoaW1hZ2VVcmxNYXRjaGVzKVxuICB9XG5cbiAgcmV0dXJuIG5vZGVTdHJpbmdcbn1cblxuY29uc3QgcHJvY2Vzc05vZGVTdHJpbmcgPSBhc3luYyAoe1xuICBub2RlU3RyaW5nLFxuICBub2RlLFxuICBwbHVnaW5PcHRpb25zLFxuICBoZWxwZXJzLFxuICB3cFVybCxcbn0pID0+IHtcbiAgLy8gY29uc3Qgbm9kZVN0cmluZ0ZpbHRlcnMgPSBbcmVwbGFjZU5vZGVIdG1sSW1hZ2VzLF1cbiAgY29uc3Qgbm9kZVN0cmluZ1dpdGhHYXRzYnlJbWFnZXMgPSByZXBsYWNlTm9kZUh0bWxJbWFnZXMoe1xuICAgIG5vZGVTdHJpbmcsXG4gICAgbm9kZSxcbiAgICBwbHVnaW5PcHRpb25zLFxuICAgIGhlbHBlcnMsXG4gICAgd3BVcmwsXG4gIH0pXG5cbiAgLy8gY29uc3QgbWVkaWFJdGVtTm9kZXMgPSBhd2FpdCBoZWxwZXJzLmdldE5vZGVzQnlUeXBlKGBXcE1lZGlhSXRlbWApXG4gIC8vIGRkKG1lZGlhSXRlbU5vZGVzKVxuXG4gIC8vIGNvbnN0IG5vZGVTdHJpbmdXaXRoR2F0c2J5SW1hZ2VzQW5kUmVsYXRpdmVMaW5rcyA9IHJlcGxhY2VOb2RlSHRtbExpbmtzKHtcbiAgLy8gICBub2RlU3RyaW5nLFxuICAvLyAgIHBsdWdpbk9wdGlvbnMsXG4gIC8vIH0pXG4gIC8vIHJldHVybiBub2RlU3RyaW5nV2l0aEdhdHNieUltYWdlc0FuZFJlbGF0aXZlTGlua3NcblxuICByZXR1cm4gbm9kZVN0cmluZ1dpdGhHYXRzYnlJbWFnZXNcbn1cblxuY29uc3QgcHJvY2Vzc05vZGUgPSBhc3luYyAoe1xuICBub2RlLFxuICBwbHVnaW5PcHRpb25zLFxuICByZWZlcmVuY2VkTWVkaWFJdGVtTm9kZUlkcyxcbiAgd3BVcmwsXG4gIGhlbHBlcnMsXG59KSA9PiB7XG4gIGNvbnN0IGFuY2hvclRhZ1JlZ2V4ID0gbmV3IFJlZ0V4cChcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdXNlbGVzcy1lc2NhcGVcbiAgICBgPGFbXFxcXFxcc10rW14+XSo/aHJlZltcXFxcXFxzXT89W1wiJ1xcXFxcXFxcXSooJHt3cFVybH0uKj8pW1wiJ1xcXFxcXFxcXSouKj8+KFtePF0rfC4qPyk/PFxcL2E+YCxcbiAgICBgZ2ltYFxuICApXG5cbiAgY29uc3Qgbm9kZVN0cmluZyA9IHN0cmluZ2lmeShub2RlKVxuXG4gIC8vIGZpbmQgcmVmZXJlbmNlZCBub2RlIGlkc1xuICBjb25zdCBub2RlTWVkaWFJdGVtSWRSZWZlcmVuY2VzID0gZmluZFJlZmVyZW5jZWRJbWFnZU5vZGVJZHMoe1xuICAgIG5vZGVTdHJpbmcsXG4gICAgcGx1Z2luT3B0aW9ucyxcbiAgICBub2RlLFxuICB9KVxuXG4gIC8vIHB1c2ggdGhlbSB0byBvdXIgc3RvcmUgb2YgcmVmZXJlbmNlZCBpZCdzXG4gIGlmIChub2RlTWVkaWFJdGVtSWRSZWZlcmVuY2VzLmxlbmd0aCkge1xuICAgIG5vZGVNZWRpYUl0ZW1JZFJlZmVyZW5jZXMuZm9yRWFjaCgoaWQpID0+XG4gICAgICByZWZlcmVuY2VkTWVkaWFJdGVtTm9kZUlkcy5hZGQoaWQpXG4gICAgKVxuICB9XG5cbiAgY29uc3QgcHJvY2Vzc2VkTm9kZVN0cmluZyA9IGF3YWl0IHByb2Nlc3NOb2RlU3RyaW5nKHtcbiAgICBub2RlU3RyaW5nLFxuICAgIG5vZGUsXG4gICAgcGx1Z2luT3B0aW9ucyxcbiAgICBoZWxwZXJzLFxuICAgIHdwVXJsLFxuICB9KVxuXG4gIC8vIG9ubHkgcGFyc2UgaWYgdGhlIG5vZGVTdHJpbmcgaGFzIGNoYW5nZWRcbiAgaWYgKHByb2Nlc3NlZE5vZGVTdHJpbmcgIT09IG5vZGVTdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2UocHJvY2Vzc2VkTm9kZVN0cmluZylcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBkdW1wKHByb2Nlc3NlZE5vZGVTdHJpbmcpXG4gICAgICBoZWxwZXJzLnJlcG9ydGVyLnBhbmljKGUpXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBub2RlXG4gIH1cbn1cblxuZXhwb3J0IHsgcHJvY2Vzc05vZGUgfVxuIl19